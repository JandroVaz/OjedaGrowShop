@using Microsoft.AspNetCore.ProtectedBrowserStorage
@using Microsoft.Extensions.Logging
@using OjedaGrowShop.Helper
@inject AuthorizationHelper authorizationHelper
@inject ProtectedSessionStorage ProtectedSessionStore


<style>

    .container__menu {
        width: 100%;
        height: 70px;
        background-color: #009624;
        padding: 0px 20px;
    }

    .enlacesMenu {
        width: 100% !important;
        height: 100% !important;
        padding: 20px;
        text-transform: uppercase;
        transition: all 300ms ease;
    }

        .enlacesMenu > a {
            font-weight: bold;
            color: black !important;
            text-decoration: none;
        }

        .enlacesMenu:hover {
            transform: scale(1.1);
            background-color: #338a3e;
            box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        }

</style>


<div class="container-fluid container__menu rounded-3">
    <img src="images/logotiporeducido.png" alt="" style="width: 75px; margin-right: 25px; border-radius: 50%;">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-between" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto  mb-lg-0 gap-2 mt-md-0" style="background-color: #009624 !important; ">
            <li class="enlacesMenu">
                <NavLink href="" Match="NavLinkMatch.All">
                    <span onclick="event.preventDefault;" class="nav-link w-100  text-white" aria-current="page">Home</span>
                </NavLink>
            </li>
            <li class="enlacesMenu">
                <NavLink href="campo">
                    <span onclick="event.preventDefault;" class="nav-link  w-100  text-white" aria-current="page">Campo</span>
                </NavLink>

            </li>
            <li class="enlacesMenu">
                <NavLink href="mascotas">
                    <span onclick="event.preventDefault;" class="nav-link  w-100  text-white" aria-current="page">Mascotas</span>
                </NavLink>
            </li>
            <li class="enlacesMenu">
                <NavLink href="contacto">
                    <span onclick="event.preventDefault;" class="nav-link  w-100  text-white" aria-current="page">Contacto</span>
                </NavLink>
            </li>
        </ul>


        @if(!authorizationHelper.IsAdmin)
            {
        <ul class="navbar-nav" style="background-color: #009624 !important; ">
            <li class="nav-item dropdown">
                <span class="nav-link  text-white dropdown-toggle enlacesMenu" href="#" style=" font-weight: bold;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Iniciar / Registrar
                </span>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <li class="enlacesMenu dropdown-item">
                        <NavLink href="login">
                            <span class="nav-link  w-100" aria-current="page">Login</span>
                        </NavLink>
                    </li>
                    <li class="enlacesMenu dropdown-item">
                        <NavLink href="register">
                            <span class="nav-link  w-100" aria-current="page">Registrarme</span>
                        </NavLink>
                    </li>
                </ul>
            </li>
        </ul>
        }else{
            <ul class="navbar-nav" style="background-color: #009624 !important; ">
            <li class="nav-item dropdown">
                <span class="nav-link  text-white dropdown-toggle enlacesMenu" href="#" style=" font-weight: bold;" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    @user
                </span>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <li class="enlacesMenu dropdown-item">
                        <NavLink href="">
                            <span class="nav-link  w-100" aria-current="page" @onclick="LogOut">Salir</span>
                        </NavLink>
                    </li>

                </ul>
            </li>
        </ul>
        }
    </div>
</div>


@code {
    private bool collapseNavMenu = true;

    private string NavMenuCssClass => collapseNavMenu ? "collapse" : null;

     [Inject]
    public IMatToaster Toaster { get; set; }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    //Carga del usuario, si el usuario ha conectado
    //Realiza la carga
    private bool isConnected;
    private bool userRol;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isConnected = true;
            await LoadStateAsync();
            StateHasChanged();

        }
    }

    private string? user;
    private async Task LoadStateAsync()
    {
        user = await ProtectedSessionStore.GetAsync<string>("user");
        StateHasChanged();
    }

    //protected override Task OnInitializedAsync()
    //{
    //    authorizationHelper.EventCallback = LoadStateAsync;
    //}

    public async Task LogOut()
    {
        authorizationHelper.IsAdmin = false;
        await ProtectedSessionStore.DeleteAsync("user");
        await ProtectedSessionStore.DeleteAsync("userId");
        Helper.MatToastHelper.Show(MatToastType.Info, "Se ha cerrado sesión correctamente.", "Log Out");
    }

}
